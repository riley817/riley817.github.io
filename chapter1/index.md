# 가상 면접 사례로 배우는 대규모 시스템 설계 기초 Study [1장] 사용자 수에 따른 규모 확장성


{{< admonition type=tip title="Note" open=true >}}
팀 내에서 진행하는 Study 정리 입니다.
{{< /admonition >}} 

# 함께 논의하고 싶은 주제
---

우리 서비스의 검색기능은 아직 없지만 인스타그램처럼 태그, 유저, 장소 등 통합 검색 기능이 추가되면 어떤 구조를 가져가면 좋을까요?


# 요약
---
## 단일서버
모든 컴포넌트가 단 한대의 서버에서 실행되는 간단한 시스템

1. 도메인 이름을 이용하여 웹사이트에 접속. 도메인 이름은 도메인 이름 서비스(Domain Name Service, DNS)에 질의하여 IP 주소 반환 
2. DNS 질의 결과로 IP 반환
3. IP 주소로 HTTP`HyperText Transfer Protocol` 요청이 전달
4. 요청을 받은 웹 서버는 HTML 페이지 JSON 형태의 응답을 반환

## 데이터베이스

관계형 데이터베이스(Relational Data-base Management System, RDBMS)가 개발자들에게는 익숙하고 오랜기간 동안 잘 사용되어진 시스템이지만 구축하려는 시스템에 따라 꼭 최선의 시스템은 아닐 수 있다. 아래의 경우 비-관계형 데이터가 바람직한 선택이 될 수 있다.

### 비-관계형 데이터베이스가 적합한 서비스
- 아주 낮은 응답 지연시간`latency`이 요구
- 다루는 데이터가 비정형`unstructured`이라 관계형 데이터가 아님
- 데이터(JSON, YAML, XMAL 등)를 직렬화하거나`serialize` 역직렬화`deserialize` 할 수 있다
- 아주 많은 양의 데이터를 저장할 필요가 있다.

{{< admonition type=Note title="🐶" open=true >}}
- 도부이결다조...(두부이걸다줘...) 이전에는 비정형 데이터의 중복을 제거하고 정규화 시키는데 집중했었다면 최근에는 데이터가 방대해짐에 따라 NoSQL 각광받고 있는 것 같다.
{{< /admonition >}} 


## 수직적 규모 확장과 수평적 규모 확장
- 수직적 규모 확장(`vertical scaling`) : `scale up`. 프로세서는 서버에 고사양 자원을 추가하는 행위
- 수평적 규모 확장(`scale out`) : `scale out`. 더 많은 서버를 추가하여 성능을 개선하는 행위

### 수직적 규모 확장의 단점
아래와 같은 단점때문에 대규모 애플리케이션을 지원하는 데는 수평적 규모 확장법이 적절하다.

- 확장의 한계가 있다. (CPU, 메모리를 무한대로 증설할 방법은 없다.)
- 장애의 자동복구(`failover`) 방안이나 다중화`re-dundancy` 방안을 제시하지 않음 

## 로드 밸런서
로드 밸런서는 부하 분산 집합`load balancing set`에 속한 웹 서버들에게 트래픽 부하를 고르게 분산함으로서 장애 자동복구와 웹 계층의 가용성을 향상시킬 수 있다.
- 서버 1이 다운되면 모든 트래픽은 서버 2로 전송된다. 따라서 웹 사이트 전체가 다운되는 일이 방지된다.

## 데이터베이스 다중화
- 데이터베이스 서버를 주`master`-부`slave` 관계를 설정하고 데이터 원본은 주 서버에, 사본은 부 서버에 저장하는 방식
- 쓰기 연산은 마스터에서만 지원하며 부 데이터베이스는 주 데이터베이스로부터 사본만 전달받고 읽기 연산만을 지원한다.

### 데이터베이스를 다중화 했을 때 장점
- **더 나은 성능** : 읽기 연산은 부 데이터베이스 서버로 분산됨으로서, 병렬로 처리될 수 있는 질의`query` 수를 늘릴 수 있다.
- **안정성`reliability`** : 데이터를 지역적으로 분산시킴으로써 다중화 시켜 데이터베이스가 일부 파괴되더라도 데이터를 보존할 수 있다.
- **가용성`availability`** : 데이터를 여러지역에 복제함으로써, 하나의 데이터베이스 서버에 장애가 발생해도 다른 서버의 데이터를 가져와 계속 서비스할 수 있다.

### 데이터베이스 다중화 시 발생할 수 있는 상황
- 부 서버가 한 대 뿐인데 다운된 경우 : 읽기 연산은 한시적으로 주 데이터베이스로 전달되고 즉시 새로운 부 데이터베이스가 장애 서버를 대체한다.
- 부 서버가 여러대 : 읽기 연산은 나머지 부 데이터베이스 서버로 분산하여 장애 서버를 대체한다.
- 부 서버가 한대이며 주 데이터베이스가 다운되었을 때 : 부 데이터베이스가 새로운 주 서버가 되고 모든 연산을 처리한다. 그리고 새로운 부 데이터베이스가 추가된다.
- 부 서버에 보관된 데이터가 최신 상태가 아닐 수 있다.
    - 복구 스크립트`recovery script`를 돌려서 데이터를 동기화 해야 한다.
    - [다중 마스터](https://en.wikipedia.org/wiki/Multi-master_replication), 원형 다중화`circular replication` 방식을 도입하여 대처


## 로드밸런서와 데이터베이스 다중화를 고려한 설계안
 {{<image src="/posts/images/system-design-interview/load-balancer-database-replication.png" width="50%">}}

- 사용자는 DNS로부터 로드밸런서의 공개 IP 주소를 받는다.
- 사용자는 해당 IP 주소를 사용해 로드밸런서에 접속
- HTTP 요청은 서버 1이나 서버 2로 전달 된다.
- 웹 서버는 사용자의 데이터를 부 데이터베이스 서버에서 읽는다.
- 웹 서버의 데이터 변경 연산은 주 데이터베이스로 전다로딘다. (데이터 추가, 삭제, 갱신 연산 등)

## 캐시
캐시는 연산 결과 또는 자주 참조되는 데이터를 메모리 안에 두고 뒤이은 요청보다 빨리 처리 될 수 있도록 하는 저장소 
